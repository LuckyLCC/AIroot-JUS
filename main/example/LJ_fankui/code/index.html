<!-- 
	类注释
	@author sunxy
	@version 0.0
 -->
<@import value="iron.*" />
<@import value="root.*" />
<style>
	#content{
		position:relative;
		overflow-x:hidden;
	}
</style>
<App>
	<TitleBar id="title"></TitleBar>
	<div id="content" style="overflow-y:scroll;height:100%;margin-top:36px;">
		
	</div>
	<pages.ControlBar id="ctrl"/>
	<div style="background: linear-gradient(to top, rgba(241,241,241,1) , rgba(241,241,241,0));position:absolute;bottom:0px;height:58px;width:100%;pointer-events:none;"></div>
</App>
<script>
	import pages.Wait;
	var _self = $(dom);
	function init(){
		var a = null;
		if(window.device){
			var wait = new Wait();
			a = wait.dom;
		}
		
		#content.find(">div").click(function(){
			if(!icc){
				Alert("正在获取数据");
				return;
			}
			if(!havData(icc)){
				Alert("此警情无反馈数据");
				return;
			}
			
			JUS.addModule(document.body,$(this).attr("url"));
		});
		#content.scroll(function(e){
			ctrl.height = 58 - e.target.scrollTop;
		});
		if(window.device){
			console.log("alarmID",device.getAlarmId());
		}
		if(window.device){
			postToServ("case/icc/feedbackList",function(e){
				var json = JSON.parse(e);
				if(json.success == 1){
					icc = json.info;
					
					if(!havData(icc)){
						Alert("返回数据为空",function(){
							if(window.device && window.device.quit){
								window.device.quit();
							}
						});
						
					}else{
						ctrl.render("反馈详情");
					}
					
				}else{
					console.log("error",e);
				}
				$(a).remove();
			},JSON.stringify({"cmd":"feedbackList","para":{"caseId":device.getAlarmId()}}));
			console.log("alarm:",device.getAlarmId());
			//},JSON.stringify({"cmd":"feedbackList","para":{"caseId":"C201811161051430001"}}));
			setInterval(function(){
				var msg = device.getMessage();
				if(msg){
					Confirm("有新数据需要覆盖",function(){
						var json = JSON.parse(msg);
						for(var i in json){
							icc[i] = json[i];
						}
						update(icc);
					});
				}
			},1000);
		}else{
			icc = icc_b;
		}
		
		
		/**
		 * 发送修改信息
		 */
		window.Submit = function(){
			
			var wait = new Wait();
			var a = wait.dom;
			
			var ef = null;
			if(!icc.feedback_code){
				ef = "请填写反馈人警号.";
			}else if(!icc.feedback_name){
				ef = "请填写反馈人姓名.";
			}else if(!icc.feedback_leader_code){
				ef = "请填写反馈领导警号.";
			}else if(!icc.feedback_leader_name){
				ef = "请填写反馈领导姓名.";
			}else if(!icc.feedback_dept_code){
				ef = "反馈单位代码"
			}else if(!icc.feedback_code){
				ef = "反馈单位代码"
			}else if(!icc.feedback_name){
				ef = "反馈人姓名"
			}else if(!icc.process_code){
				ef = "接警人警号";
			}else if(!icc.process_name){
				ef = "接警人姓名";
			}else if(!icc.process_dept_code){
				ef = "处警单位代码";
			}else if(!icc.process_leader_code){
				ef = "处警领导警号";
			}else if(!icc.process_leader_name){
				ef = "处警领导姓名";
			}else if(!icc.process_code){
				ef = "处警人警号";
			}else if(!icc.process_name){
				ef = "处警人姓名";
			}else if(!icc.result_type){
				ef = "处理结果";
			}else if(!icc.result_content){
				ef = "处理结果内容";
			}else if(!icc.alarm_first_type){
				ef = "事件类别";
			}else if(!icc.people_num_capture){
				ef = "抓获人数";
			}else if(!icc.people_num_rescue){
				ef = "救助人数";
			}else if(!icc.people_num_slight_injury){
				ef = "轻伤人数";
			}else if(!icc.police_num_dispatch){
				ef = "出动警力";
			}else if(!icc.police_car_num_dispatch){
				ef = "出动车辆数";
			}else if(!icc.people_num_serious_injury){
				ef = "重伤人数";
			}else if(!icc.people_num_death){
				ef = "死亡人数";
			}
			
			if(ef){
				Alert(ef);
				$(a).remove();
				return false;
			}
			
			var obj = {cmd:"feedbackToIcc",para:icc};
			postToServ("case/icc/feedbackToIcc",function(e){
				try{
					var json = JSON.parse(e);
					console.log("JSON",json);
					if(json.success == 1){
						Alert("保存成功");
						$(a).remove();
					}else{
						Alert("保存失败");
					}
				}catch(ex){
					Alert("保存失败");
					console.log("JSONCACHE",e);
					$(a).remove();
				}
				
				
			},JSON.stringify(obj));
			return true;
			
		}
		
		title.onEdit = function(e){
			var p = window[#content.find(">div").eq(0).attr("id")];
			if(p){
				p.editabled = true;
			}
		};
		title.onSave = function(e){
			var p = window[#content.find(">div").eq(0).attr("id")];
			if(p){
				p.editabled = false;
			}
		};
		
		ctrl.setTarget(document.getElementById("$content"));
		
		
	}
	
	function havData(){
		for(var i in icc){
			return true;
		}
		return false;
	}
</script>